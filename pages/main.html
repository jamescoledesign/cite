<link rel="stylesheet" href="../src/style.css">

<style>

body {
    background-color: var(--figma-color-bg);
    color: var(--figma-color-text);
    padding: 0 0 54px 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    margin: 0 auto;
    position: relative;
}

div.top {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    margin: 0 0 10px 0;
    padding: 0 10px;
}

h1 {
    font-size: 24px;
    margin: 0;
}

h2 {
    font-size: 20px;
    margin: 0px;
}

div.container {
    padding: 0 10px;
}

form {
    display: flex !important;
    flex-direction: row;
    margin: 0;
    width: 100%;
    border-radius: 6px;
    background-color: #ffffff;
    font-size: 12px;
}

form:focus-within {
    outline: 2px solid var(--figma-color-bg-selected-strong);
    outline-offset: 2px;
}

label {
    font-size: 14px;
}

input {
    width: 100%;
    height: 44px;
    padding: 0 10px;
    margin: 10px 0 10px 0;
}

input.input__field {
    border: 1px solid rgba(0, 0, 0, .3);
}

input.searchfield {
    border: unset;
    margin: 0;
}

input.searchfield:focus {
    outline: none;
}

svg.icon {
    min-width: 14px;
    max-width: 14px;
    padding-left: 10px;
    color: var(--figma-color-bg);
    border-radius: 6px 0 0 6px;
}

select {
    margin: 0;
    border: none;
    border-radius: 0 6px 6px 0;
    font-size: 12;
    text-align: left;
    max-width: 100px;
    border-left: 1px solid gray;
    margin: 10px;
    padding: 0 8px 0 4px ;
}

select:focus {
    outline: none;
}

button {
    margin: 10px 0 10px 0;
    min-width: 80px;
}

button.login {
    max-width: 80px;
}

button.small {
    margin: 10px 0 10px 0;
    min-width: 80px;
    background-color: var(--figma-color-bg);
    color: var(--figma-color-text);
    border: 1px solid var(--figma-color-border-strong);
}

button.small:hover {
    opacity: .9;
    cursor: pointer;
}

button.large {
    font-size: 14px;
    padding: 10px 12px;
    height: 44px;
    min-width: 120px;
    width: 100%;
}

button.add {
    margin: 0;
    display: none;
    align-self: flex-end;
    z-index: 1;
    position: fixed;
    bottom: 0;
    left: 0;
    min-height: 60px;
    background-color: var(--figma-color-bg-selected-strong);
    color: var(--figma-color-text-onselected);
    border: 1px solid var(--figma-color-border-selected-strong);
}

div.results-list { 
    margin: 0;
    padding: 0;
}

div.results-container {
    display: flex;
    margin: 0 auto;
    padding: 20px 10px 20px 10px;
    border-bottom: 1px solid var(--figma-color-bg-hover);
}

div.title {
    font-size: 16px;
    font-weight: 500;
    color: var(--figma-color-text);
}

div.author {
    font-size: 14px;
    color: var(--figma-color-text);
    padding-top: 10px;
    opacity: 0.8;
}

div.results-container:hover {
    background-color: var(--figma-color-bg-hover);
    cursor: pointer;
    border-radius: 6px;
}

div.results-toolbar {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
}

div.selection-stats {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

div.number-selected {
    font-size: 12px;
    margin-right: 10px;
}

div.search-result-section {
    display: flex;
    flex-direction: column;
    margin: 0 0 20px 0;
    color: var(--figma-color-text);
}

div.plugin-message {
    display: none;
}

div.success {
    margin: 0 auto;
    background-color: var(--figma-color-bg-success-tertiary);
    color: var(--figma-color-text-success);
    margin: 20px 0 0 0;
    padding: 20px;
    text-align: center;
}

</style>

<body>

<div class="top">
    <h1>Search</h1>
    <button class="button login" onclick="openLogin()">Configure</button>
</div>

<div class="container">
    <form class="search-area">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><g id="magnifying-glass--glass-search-magnifying"><path id="Vector" stroke="#3e3e3e" stroke-linecap="round" stroke-linejoin="round" d="M6 11.5a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11Z"></path><path id="Vector_2" stroke="#3e3e3e" stroke-linecap="round" stroke-linejoin="round" d="M13.5 13.5 10 10"></path></g></svg>

        <input id="search-field" class="input__field searchfield" placeholder="Search..." type="search" required>

        <!--<button class="button large" id="submit-query" onclick="checkInput()">Search</button>-->

        <select id="options" name="search-options">
            <option value="everything">All</option>
            <option value="title-creator-year">Title</option>
            <option value="all-fields-tags">Authors</option>
        </select>
    </form>
</div>

<div id="all-results" class="results-container">
    <!--
    <div class="results-toolbar">
        <div class="selection-stats">
            <div id="number-of-selections" class="number-selected">0 selected</div>
            <button class="button small" id="clear-all" onclick="clearAll()">Reset</button>
        </div>
    </div>
    -->
    <div id="search-results" class="search-result-section">Loading...</div>
</div>

<div id="plugin-message" class="plugin-message">
    <div class="success">âœ“ Success</div>
    <button class="button large" onclick="clearAll()">Reset</button>
</div>

<button class="button large add" id="add-selection">Add to Figma</button>

</body>

<script>

    let title, authors, selectionTitle, selectionAuthors;
    let authorArr = [];
    let clicked = false;

    // only search if there's data in the input field
    function checkInput() {
        const searchTerm = document.getElementById('search-field').value;
        let exists = false;
        if (searchTerm == "") {
            return exists
        } else {
            clearAll();
            sendToZotero(searchTerm);
        }
    } 

    // listen for Enter key
    document.getElementById('search-field').addEventListener('keypress', function(event) {
            if (event.keyCode == 13) {
                event.preventDefault();
                checkInput();
            }
        });

    // send search term to Zotero
    function sendToZotero(keyword) {
        const search = true;
        const searchResults = document.getElementById('search-results').innerHTML;
        console.log(keyword);
        document.getElementById('add-selection').style.display = "none";
        document.getElementById('all-results').style.display = "unset";
        parent.postMessage({pluginMessage: {search, keyword, searchResults}}, '*');
    }

    // load search results in UI
    onmessage = (event) => {
        const clear = true;
        let results = event.data.pluginMessage;
        console.log(results);
        let item = 1;
        if (typeof results === "object") {
            // create new html, need to break title and author lines
        let resultsList =
            '<div class="results-list">' +
                results.map(function (result) {

                    title = result.title;
                    authors = result.authors;
                    authorArr = []; // clear each time

                    if (typeof authors == "undefined") {
                        authorArr.push("Authors not provided");
                    } else {
                        authors.forEach(element => {
                            author = element.lastName + ", " + element.firstName;
                            authorArr.push(author);
                        });
                    }
                    let itemId = `item${item++}`;
                    let titleId = `title-${itemId}`;
                    let authorId = `authors-${itemId}`;
                    return `
                    <div id='${itemId}' class='result-container'><div id='${titleId}' class='title' onclick='makeSelection("${itemId}", "${title}", "${authorArr}")'>${title}</div><div id='${authorId}' class='author'>${authorArr}</div>
                    </div>
                    `;
                }).join('') +
            '</div>';
            // add list to UI
            document.getElementById('search-results').innerHTML = resultsList;
        } else {
            document.getElementById('add-selection').style.display = "unset";
        }
    }

    function makeSelection(id, title, authors) {
        let clickedItem = document.getElementById(id);
        let addSelection = document.getElementById('add-selection')
        if (clicked === false) {
            addSelection.style.display = "unset";
            clickedItem.style.backgroundColor = "var(--figma-color-bg-success-tertiary)";
            clickedItem.style.color = "var(--figma-color-text-success)";
            selectionTitle = title; 
            selectionAuthors = authors;
            clicked = true;
        } else if (clicked === true) {
            addSelection.style.display = "none";
            clickedItem.style.backgroundColor = "var(--figma-color-bg)";
            clickedItem.style.color = "var(--figma-color-text)";
            clicked = false;
        }
        parent.postMessage({pluginMessage: {selectionTitle, selectionAuthors}}, '*');
    }

    // clear search results
    function clearAll() {
        const clear = true;
        document.getElementById('all-results').style.display = "none";
        document.getElementById('add-selection').style.display = "none";
        document.getElementById('plugin-message').style.display = "none";
        parent.postMessage({pluginMessage: {clear}}, '*');
    }

    // Submit selection to Figma and write text node
    document.getElementById('add-selection').onclick = () => {
        const submit = true;
        const clear = true;
        document.getElementById('all-results').style.display = "none";
        document.getElementById('add-selection').style.display = "none";
        document.getElementById('plugin-message').style.display = "unset";
        parent.postMessage({pluginMessage: {submit, selectionTitle, selectionAuthors}}, '*');
    }

    function openLogin() {
        let login = true;
        parent.postMessage({pluginMessage: {login}}, '*'); 
    }
    
  </script>