<link rel="stylesheet" href="../src/style.css">

<style>

:root {
    --main-bg: #ffffff;
    --secondary-bg: #2C2C2C;
    --main-text: rgba(0, 0, 0, 0.90);
    --secondary-text: #b3b3b3;
    --main-blue: #0D99FF;
    --light-border: rgba(0, 0, 0, 0.10);
    --button-hover: #f5f5f5;
}


body {
    background-color: var(--main-bg);
    color: var(--main-text);
    padding: 0 0 54px 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    margin: 0 auto;
    position: relative;
}

div.container {
    padding: 10px 10px 54px 10px;
}

/* Nav styles */

nav {
    display: flex;
    max-width: 100%;
    height: 40px;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;  
    border-bottom: 1px solid var(--light-border);
    padding: 0 4px 0px 16px;
}

div.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    color: white;
    display: none;
    position: absolute;
    top: 28px;
    background-color: black;
    min-width: 160px;
    overflow: auto;
    box-shadow: 0px 5px 17px 0px rgba(0, 0, 0, 0.20), 0px 2px 7px 0px rgba(0, 0, 0, 0.15);
    z-index: 1;
    margin-top: 12px;
    font-family: Inter, sans-serif;
    font-size: 11px;
    font-style: normal;
    line-height: 16px;
    letter-spacing: 0.055px;
}

svg.dropdown-arrow {
    margin-left: 4px;
}

.dropdown-content a {
    color: white;
    padding: 8px 16px;
    margin: 8px 0;
    text-decoration: none;
    display: block;
}

.dropdown-content a:hover {
    background-color: var(--main-blue);
}

.show {
    display: block;
}

.right {
    right: 8px;
}

a:focus-visible {
    outline: 2px solid var(--main-blue);
    outline-offset: 2px;
}

a.link {
    color: var(--main-text);
    text-align: center;
    font-family: Inter, sans-serif;
    font-size: 14px;
    font-style: normal;
    font-weight: 500;
    line-height: 24px; /* 171.429% */
    letter-spacing: -0.084px;
    margin-top: 20px;
}

svg.meatballs-menu {
    background-color: white;
    border-radius: 2px;
}

svg.meatballs-menu:hover {
    background-color: var(--button-hover);
}

svg.clicked {
    background-color: var(--main-blue);
    color: white;
}

svg.clicked:hover {
    background-color: var(--main-blue);
}

ul { 
    list-style-type: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: row;
}

li {
    color: var(--main-text);
    font-family: Inter, sans-serif;
    font-size: 11px;
    font-style: normal;
    font-weight: 600;
    line-height: 16px; /* 145.455% */
    letter-spacing: 0.055px;
    margin-right: 16px;
}

li:hover {
    cursor: pointer;
}

li:focus-visible {
    outline: 2px solid var(--main-blue);
    outline-offset: 2px;
}

li.nav-link {
    text-decoration: none;
    align-items: center;
    display: flex;
}

li.nav-link:hover {
    color: var(--main-text);
    cursor: pointer;
    border-bottom: 1px solid var(--main-text)
}

.selected {
    color: var(--main-text);
}

.notselected {
    color: var(--secondary-text);
}

.notselected:hover {
    color: var(--main-text);
}

h1 {
    font-size: 24px;
    margin: 0;
}

h2 {
    font-size: 20px;
    margin: 0px;
}

div.search-container {
    padding: 0 10px;
    border-bottom: 1px solid var(--light-border);
    
}

form {
    display: flex !important;
    flex-direction: row;
    margin: 0;
    width: 100%;
    border-radius: 6px;
    background-color: #ffffff;
    font-size: 12px;
}

form:focus-within {
    outline: 2px solid var(--main-bg-selected-strong);
    outline-offset: 2px;
}

label {
    font-size: 14px;
}

input {
    width: 100%;
    height: 40px;
    padding: 0 10px;
    margin: 10px 0 10px 0;
}

input.input__field {
    border: 1px solid rgba(0, 0, 0, .3);
}

input.searchfield {
    border: unset;
    margin: 0;
}

input.searchfield:focus {
    outline: none;
}

svg.icon {
    min-width: 14px;
    max-width: 14px;
    padding-left: 10px;
    color: var(--main-bg);
    border-radius: 6px 0 0 6px;
}

select {
    margin: 0;
    border: none;
    border-radius: 0 6px 6px 0;
    font-size: 12;
    text-align: left;
    max-width: 100px;
    border-left: 1px solid gray;
    margin: 10px;
    padding: 0 8px 0 4px ;
}

select:focus {
    outline: none;
}

button {
    margin: 10px 0 10px 0;
    min-width: 80px;
}

button:focus-visible {
    outline: 2px solid var(--main-blue);
    outline-offset: 2px;
}

button.login {
    max-width: 80px;
}

button.small {
    margin: 10px 0 10px 0;
    min-width: 80px;
    background-color: var(--main-bg);
    color: var(--main-text);
    border: 1px solid var(--figma-color-border-strong);
}

button.small:hover {
    opacity: .9;
    cursor: pointer;
}

button.large {
    font-size: 14px;
    padding: 10px 12px;
    height: 44px;
    min-width: 120px;
    width: 100%;
}

button.add {
    margin: 0;
    display: none;
    align-self: flex-end;
    z-index: 1;
    position: fixed;
    bottom: 0;
    left: 0;
    min-height: 60px;
    background-color: var(--main-blue);
    color: white;
    border: none;
}

div.results-list { 
    margin: 0;
    padding: 0;
}

div.results-container {
    display: none;
    padding: 10px;
    
}

div.result-item {
    border-radius: 6px;
    border-bottom: 1px solid var(--main-bg-hover);
    padding: 20px 10px 20px 10px;
}

div.result-item:hover {
    background-color: var(--main-bg-hover);
    cursor: pointer;
    border-radius: 6px;
}

div.title {
    font-size: 16px;
    line-height: 22px;
    font-weight: 500;
    color: var(--main-text);
}

div.author {
    font-size: 14px;
    line-height: 20px;
    color: var(--main-text);
    padding-top: 10px;
    opacity: 0.7;
}

div.results-toolbar {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
}

div.selection-stats {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

div.number-selected {
    font-size: 12px;
    margin-right: 10px;
}

div.search-result-section {
    display: flex;
    flex-direction: column;
    margin: 0 0 20px 0;
    color: var(--main-text);
}

div.plugin-message {
    display: none;
}

div.success {
    margin: 0 auto;
    background-color: var(--main-bg-success-tertiary);
    color: var(--main-text-success);
    margin: 20px 0 0 0;
    padding: 20px;
    text-align: center;
}

</style>

<nav class="menu">
    <ul>
    <li class="nav-link">
        <div id="dropdownText" class="dropdown notselected" onclick="toggleDropdown()">API Key
            <svg id="arrow-icon" class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" width="8" height="5" viewBox="0 0 8 5" fill="none">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M3.6459 4.35301L0 0.707107L0.707107 0L3.99946 3.29235L7.29181 0L7.99892 0.707107L4.35301 4.35301L3.99946 4.70656L3.6459 4.35301Z" fill="currentColor" fill-opacity="1"/>
                </svg>
        </div>
        <div id="api-drop-content" class="dropdown-content">
            <a class="subnavlink" onclick="openLogin()" href="#home">Update key</a>
            <a class="subnavlink" href="#home" onclick="deleteKeys()">Delete key</a>
        </div>
    </li>
    <li class="nav-link selected" onclick="closeLogin()">Search</li>
    </ul>

    <svg id="meatballs" onclick="toggleMeatballs()" class="meatballs-menu" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M11.5 16C11.5 16.8284 10.8284 17.5 10 17.5C9.17157 17.5 8.5 16.8284 8.5 16C8.5 15.1716 9.17157 14.5 10 14.5C10.8284 14.5 11.5 15.1716 11.5 16ZM17.5 16C17.5 16.8284 16.8284 17.5 16 17.5C15.1716 17.5 14.5 16.8284 14.5 16C14.5 15.1716 15.1716 14.5 16 14.5C16.8284 14.5 17.5 15.1716 17.5 16ZM22 17.5C22.8284 17.5 23.5 16.8284 23.5 16C23.5 15.1716 22.8284 14.5 22 14.5C21.1716 14.5 20.5 15.1716 20.5 16C20.5 16.8284 21.1716 17.5 22 17.5Z" fill="currentColor"/>
      </svg>

      <div id="meatball-drop-content" class="dropdown-content right">
        <a class="subnavlink" href="https://github.com/" target="_blank" rel="noopener noreferrer">Contribute</a>
        <a class="subnavlink" href="#home">About</a>
    </div>
    
</nav>

<div class="search-container">
    <form class="search-area">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><g id="magnifying-glass--glass-search-magnifying"><path id="Vector" stroke="#3e3e3e" stroke-linecap="round" stroke-linejoin="round" d="M6 11.5a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11Z"></path><path id="Vector_2" stroke="#3e3e3e" stroke-linecap="round" stroke-linejoin="round" d="M13.5 13.5 10 10"></path></g></svg>

        <input id="search-field" class="input__field searchfield" placeholder="Search..." type="search" required>

    </form>
</div>

<div id="all-results" class="results-container">

    <div id="search-results" class="search-result-section">Loading...</div>
</div>

<div id="plugin-message" class="plugin-message">
    <div class="success">âœ“ Success</div>
    <button class="button large" onclick="clearAll()">Reset</button>
</div>

<button class="button large add" id="add-selection">Add to Figma</button>


<script>

    let title, authors, selectionTitle, selectionAuthors;
    let authorArr = [];
    let clicked = false;
    let done = false;
    let show = false;
    let visible = true;

function changeIcon() {
    let icon = document.getElementById("pwicon"); 
    if (visible === false) {
        visible = true;
        icon.innerHTML = `<path d="M10.3657 10.3554C12.0646 9.25145 14.036 8.42859 16.1428 8.42859C20.9257 8.42859 25.0228 12.6714 26.8228 14.8503C27.1074 15.2052 27.2651 15.6663 27.2651 16.1429C27.2651 16.6212 27.1074 17.0806 26.8228 17.4354C25.8303 18.6354 24.14 20.4646 22.0228 21.8634M18.7143 23.4629C17.888 23.7132 17.0274 23.8572 16.1428 23.8572C11.36 23.8572 7.26284 19.6143 5.46284 17.4354C5.17344 17.067 5.01753 16.6114 5.02055 16.1429C5.02055 15.6663 5.17827 15.2052 5.46284 14.8503C6.03369 14.1612 6.83427 13.2629 7.81484 12.3577" stroke="black" stroke-width="1.71429" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.5667 18.5668C19.1913 17.9202 19.5369 17.0541 19.5291 16.1552C19.5213 15.2562 19.1607 14.3963 18.525 13.7606C17.8893 13.1249 17.0294 12.7644 16.1304 12.7565C15.2315 12.7487 14.3654 13.0943 13.7188 13.7188" stroke="black" stroke-width="1.71429" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M27.2857 27.2857L5 5" stroke="black" stroke-width="1.71429" stroke-linecap="round" stroke-linejoin="round"/>`;
    } else {
        visible = false;
        icon.innerHTML = `<path d="M26.8023 14.4217C27.0869 14.7766 27.2446 15.2377 27.2446 15.7143C27.2446 16.1926 27.0869 16.652 26.8023 17.0069C25.0023 19.1857 20.9052 23.4286 16.1223 23.4286C11.3395 23.4286 7.24233 19.1857 5.44233 17.0069C5.15293 16.6384 4.99702 16.1828 5.00004 15.7143C5.00004 15.2377 5.15776 14.7766 5.44233 14.4217C7.24233 12.2429 11.3395 8 16.1223 8C20.9052 8 25.0023 12.2429 26.8023 14.4217Z" stroke="black" stroke-width="1.71429" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16.1224 19.1428C17.0317 19.1428 17.9038 18.7816 18.5468 18.1386C19.1898 17.4957 19.551 16.6236 19.551 15.7143C19.551 14.805 19.1898 13.9329 18.5468 13.2899C17.9038 12.6469 17.0317 12.2857 16.1224 12.2857C15.2131 12.2857 14.341 12.6469 13.6981 13.2899C13.0551 13.9329 12.6938 14.805 12.6938 15.7143C12.6938 16.6236 13.0551 17.4957 13.6981 18.1386C14.341 18.7816 15.2131 19.1428 16.1224 19.1428Z" stroke="black" stroke-width="1.71429" stroke-linecap="round" stroke-linejoin="round"/>`;
    }
    console.log(visible);
}

function showPw() {
  var x = document.getElementById("apikey-field");
  changeIcon();
  if (x.type === "password") {
    
    x.type = "text";
  } else {
    
    x.type = "password";
  }
}

// Toggle dropdown content
function toggleDropdown() {
    document.getElementById("api-drop-content").classList.toggle("show");
}

function toggleMetaballDropdown() {
    let meatballMenu = document.getElementById("meatball-drop-content");
    if (show === false) {
        show = true;
        meatballMenu.style.display = "block";
    } else {
        meatballMenu.style.display = "none";
        show = false;
    }
}

function toggleMeatballs() {
    let button = document.getElementById("meatballs");
    button.classList.toggle("clicked");
    toggleMetaballDropdown();
}

// Close the dropdown if the user clicks outside of it
window.addEventListener("click", function(event) {
      if (!event.target.matches('.dropdown')) {
        let dropdowns = document.getElementsByClassName("dropdown-content");
        let i;
        for (i = 0; i < dropdowns.length; i++) {
        let openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
        }
    }
  }
});

// Set user ID and API key from input fields on submit
async function setCredentials() {
    let userId = document.getElementById('uid-field').value;
    let apiKey = document.getElementById('apikey-field').value;
    if (userId === "" || apiKey === "") {
        console.log("Please enter a user id and api key");
    } else {
        done = true;
        parent.postMessage({pluginMessage: {userId, apiKey, done}}, '*');
    }
}

function closeLogin() {
    done = true;
    parent.postMessage({pluginMessage: {done}}, '*'); 
}

function deleteKeys() {
    toggleDropdown();
    let deleteKeys = true;
    parent.postMessage({pluginMessage: {deleteKeys}}, '*'); 
    displayModal();
    modal.style.display = "block";
    document.getElementById("modal-message").innerHTML = "Your info has been deleted. You can close the plugin or enter a new Zotero API Key and User ID."
}

// only search if there's data in the input field
function checkInput() {
    const searchTerm = document.getElementById('search-field').value;
    let exists = false;
    if (searchTerm == "") {
        return exists
    } else {
        clearAll();
        sendToZotero(searchTerm);
    }
} 

// listen for Enter key
document.getElementById('search-field').addEventListener('keypress', function(event) {
        if (event.keyCode == 13) {
            event.preventDefault();
            checkInput();
        }
    });

// send search term to Zotero
function sendToZotero(keyword) {
    const search = true;
    const searchResults = document.getElementById('search-results').innerHTML;
    console.log(keyword);
    document.getElementById('add-selection').style.display = "none";
    document.getElementById('all-results').style.display = "unset";
    parent.postMessage({pluginMessage: {search, keyword, searchResults}}, '*');
}

// load search results in UI
onmessage = (event) => {
    const clear = true;
    let results = event.data.pluginMessage;
    console.log(results);
    let item = 1;
    if (typeof results === "object") {
    // pass search results to UI
    let resultsList =
        '<div class="results-list">' +
            results.map(function (result) {

                let itemId = `item${item++}`;
                let titleId = `title-${itemId}`;
                let authorId = `authors-${itemId}`;

                title = result.title;
                authors = result.authors;
                authorArr = []; // clear each time

                if (typeof authors == "undefined") {
                    authorArr.push("Authors not provided");
                } else {
                    authors.forEach(element => {
                        author = element.lastName + ", " + element.firstName;
                        authorArr.push(author);
                    });
                }

                return `
                <div id='${itemId}' class='result-item'><div id='${titleId}' class='title' onclick='makeSelection("${itemId}", "${title}", "${authorArr}")'>${title}</div><div id='${authorId}' class='author'>${authorArr}</div>
                </div>
                `;
            }).join('') +
        '</div>';
        // add list to UI
        document.getElementById('search-results').innerHTML = resultsList;
    } else {
        document.getElementById('add-selection').style.display = "unset";
    }
}

// indicate item is clicked
function makeSelection(id, title, authors) {
    let clickedItem = document.getElementById(id);
    let addSelection = document.getElementById('add-selection')
    if (clicked === false) {
        addSelection.style.display = "unset";
        clickedItem.style.backgroundColor = "var(--main-bg-success-tertiary)";
        clickedItem.style.color = "var(--main-text-success)";
        selectionTitle = title; 
        selectionAuthors = authors;
        clicked = true;
    } else if (clicked === true) {
        addSelection.style.display = "none";
        clickedItem.style.backgroundColor = "var(--main-bg)";
        clickedItem.style.color = "var(--main-text)";
        clicked = false;
    }
    parent.postMessage({pluginMessage: {selectionTitle, selectionAuthors}}, '*');
}

// clear search results
function clearAll() {
    const clear = true;
    document.getElementById('all-results').style.display = "none";
    document.getElementById('add-selection').style.display = "none";
    document.getElementById('plugin-message').style.display = "none";
    parent.postMessage({pluginMessage: {clear}}, '*');
}

// Submit selection to Figma and write text node
document.getElementById('add-selection').onclick = () => {
    const submit = true;
    const clear = true;
    document.getElementById('all-results').style.display = "none";
    document.getElementById('add-selection').style.display = "none";
    document.getElementById('plugin-message').style.display = "unset";
    parent.postMessage({pluginMessage: {submit, selectionTitle, selectionAuthors}}, '*');
}

function openLogin() {
    let login = true;
    parent.postMessage({pluginMessage: {login}}, '*'); 
}
    
  </script>