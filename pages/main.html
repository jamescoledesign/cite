<link rel="stylesheet" href="../src/style.css">

<style>

:root {
  --main-bg: #ffffff;
  --main-bg-hover: #F0F0F0;
  --secondary-bg: #2C2C2C;
  --main-text: rgba(0, 0, 0, 0.90);
  --main-blue: #0D99FF;
  --light-border: rgba(0, 0, 0, 0.10);
  --main-bg-success-tertiary: #cff7d3;
  --main-text-success: #009951;
}


body {
    background-color: var(--main-bg);
    color: var(--main-text);
    padding: 0 0 54px 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    margin: 0 auto;
    position: relative;
}

div.container {
    padding: 10px 10px 54px 10px;
}

a.nav-link {
    color: var(--main-text);
    text-decoration-line: none;
}

a.link {
    color: var(--main-text);
    text-align: center;
    font-family: Inter;
    font-size: 14px;
    font-style: normal;
    font-weight: 500;
    line-height: 24px; /* 171.429% */
    letter-spacing: -0.084px;
    margin-top: 20px;
}

a:hover {
    opacity: 0.7;
}

nav {
    display: flex;
    max-width: 100%;
    height: 40px;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;  
    border-bottom: 1px solid var(--light-border);
    padding: 0 8px 0px 16px;
}

ul { 
    list-style-type: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: row;
}

li {
    color: var(--main-text);
    font-family: Inter, sans-serif;
    font-size: 11px;
    font-style: normal;
    font-weight: 600;
    line-height: 16px; /* 145.455% */
    letter-spacing: 0.055px;
    margin-right: 16px;
}

li:hover {
    cursor: pointer;
}

h1 {
    font-size: 24px;
    margin: 0;
}

h2 {
    font-size: 20px;
    margin: 0px;
}

div.search-container {
    padding: 0 10px;
    border-bottom: 1px solid var(--light-border);
    
}

form {
    display: flex !important;
    flex-direction: row;
    margin: 0;
    width: 100%;
    border-radius: 6px;
    background-color: #ffffff;
    font-size: 12px;
}

form:focus-within {
    outline: 2px solid var(--main-bg-selected-strong);
    outline-offset: 2px;
}

label {
    font-size: 14px;
}

input {
    width: 100%;
    height: 40px;
    padding: 0 10px;
    margin: 10px 0 10px 0;
}

input.input__field {
    border: 1px solid rgba(0, 0, 0, .3);
}

input.searchfield {
    border: unset;
    margin: 0;
}

input.searchfield:focus {
    outline: none;
}

svg.icon {
    min-width: 14px;
    max-width: 14px;
    padding-left: 10px;
    color: var(--main-bg);
    border-radius: 6px 0 0 6px;
}

select {
    margin: 0;
    border: none;
    border-radius: 0 6px 6px 0;
    font-size: 12;
    text-align: left;
    max-width: 100px;
    border-left: 1px solid gray;
    margin: 10px;
    padding: 0 8px 0 4px ;
}

select:focus {
    outline: none;
}

button {
    margin: 10px 0 10px 0;
    min-width: 80px;
}

button.login {
    max-width: 80px;
}

button.small {
    margin: 10px 0 10px 0;
    min-width: 80px;
    background-color: var(--main-bg);
    color: var(--main-text);
    border: 1px solid var(--figma-color-border-strong);
}

button.small:hover {
    opacity: .9;
    cursor: pointer;
}

button.large {
    font-size: 14px;
    padding: 10px 12px;
    height: 44px;
    min-width: 120px;
    width: 100%;
}

button.add {
    margin: 0;
    display: none;
    align-self: flex-end;
    z-index: 1;
    position: fixed;
    bottom: 0;
    left: 0;
    min-height: 60px;
    background-color: var(--main-blue);
    color: white;
    border: none;
}

div.results-list { 
    margin: 0;
    padding: 0;
}

div.results-container {
    display: none;
    padding: 10px;
    
}

div.result-item {
    border-radius: 6px;
    border-bottom: 1px solid var(--main-bg-hover);
    padding: 20px 10px 20px 10px;
}

div.result-item:hover {
    background-color: var(--main-bg-hover);
    cursor: pointer;
    border-radius: 6px;
}

div.title {
    font-size: 16px;
    line-height: 22px;
    font-weight: 500;
    color: var(--main-text);
}

div.author {
    font-size: 14px;
    line-height: 20px;
    color: var(--main-text);
    padding-top: 10px;
    opacity: 0.7;
}

div.results-toolbar {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
}

div.selection-stats {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

div.number-selected {
    font-size: 12px;
    margin-right: 10px;
}

div.search-result-section {
    display: flex;
    flex-direction: column;
    margin: 0 0 20px 0;
    color: var(--main-text);
}

div.plugin-message {
    display: none;
}

div.success {
    margin: 0 auto;
    background-color: var(--main-bg-success-tertiary);
    color: var(--main-text-success);
    margin: 20px 0 0 0;
    padding: 20px;
    text-align: center;
}

</style>


<body>
    
<nav class="menu">
    <ul>
      <li><a class="nav-link" href="#">Search</a></li>
      <li><a class="nav-link" href="#" onclick="openLogin()">API Key</a></li>
    </ul>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M11.5 16C11.5 16.8284 10.8284 17.5 10 17.5C9.17157 17.5 8.5 16.8284 8.5 16C8.5 15.1716 9.17157 14.5 10 14.5C10.8284 14.5 11.5 15.1716 11.5 16ZM17.5 16C17.5 16.8284 16.8284 17.5 16 17.5C15.1716 17.5 14.5 16.8284 14.5 16C14.5 15.1716 15.1716 14.5 16 14.5C16.8284 14.5 17.5 15.1716 17.5 16ZM22 17.5C22.8284 17.5 23.5 16.8284 23.5 16C23.5 15.1716 22.8284 14.5 22 14.5C21.1716 14.5 20.5 15.1716 20.5 16C20.5 16.8284 21.1716 17.5 22 17.5Z" fill="black" fill-opacity="0.8"/>
      </svg>
</nav>

<div class="search-container">
    <form class="search-area">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><g id="magnifying-glass--glass-search-magnifying"><path id="Vector" stroke="#3e3e3e" stroke-linecap="round" stroke-linejoin="round" d="M6 11.5a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11Z"></path><path id="Vector_2" stroke="#3e3e3e" stroke-linecap="round" stroke-linejoin="round" d="M13.5 13.5 10 10"></path></g></svg>

        <input id="search-field" class="input__field searchfield" placeholder="Search..." type="search" required>

        <!--<button class="button large" id="submit-query" onclick="checkInput()">Search</button>-->


    </form>
</div>

<div id="all-results" class="results-container">
    <!--
    <div class="results-toolbar">
        <div class="selection-stats">
            <div id="number-of-selections" class="number-selected">0 selected</div>
            <button class="button small" id="clear-all" onclick="clearAll()">Reset</button>
        </div>
    </div>
    -->
    <div id="search-results" class="search-result-section">Loading...</div>
</div>

<div id="plugin-message" class="plugin-message">
    <div class="success">âœ“ Success</div>
    <button class="button large" onclick="clearAll()">Reset</button>
</div>

<button class="button large add" id="add-selection">Add to Figma</button>

</body>

<script>

    let title, authors, selectionTitle, selectionAuthors;
    let authorArr = [];
    let clicked = false;

    // only search if there's data in the input field
    function checkInput() {
        const searchTerm = document.getElementById('search-field').value;
        let exists = false;
        if (searchTerm == "") {
            return exists
        } else {
            clearAll();
            sendToZotero(searchTerm);
        }
    } 

    // listen for Enter key
    document.getElementById('search-field').addEventListener('keypress', function(event) {
            if (event.keyCode == 13) {
                event.preventDefault();
                checkInput();
            }
        });

    // send search term to Zotero
    function sendToZotero(keyword) {
        const search = true;
        const searchResults = document.getElementById('search-results').innerHTML;
        console.log(keyword);
        document.getElementById('add-selection').style.display = "none";
        document.getElementById('all-results').style.display = "unset";
        parent.postMessage({pluginMessage: {search, keyword, searchResults}}, '*');
    }

    // load search results in UI
    onmessage = (event) => {
        const clear = true;
        let results = event.data.pluginMessage;
        console.log(results);
        let item = 1;
        if (typeof results === "object") {
        // pass search results to UI
        let resultsList =
            '<div class="results-list">' +
                results.map(function (result) {

                    let itemId = `item${item++}`;
                    let titleId = `title-${itemId}`;
                    let authorId = `authors-${itemId}`;

                    title = result.title;
                    authors = result.authors;
                    authorArr = []; // clear each time

                    if (typeof authors == "undefined") {
                        authorArr.push("Authors not provided");
                    } else {
                        authors.forEach(element => {
                            author = element.lastName + ", " + element.firstName;
                            authorArr.push(author);
                        });
                    }

                    return `
                    <div id='${itemId}' class='result-item'><div id='${titleId}' class='title' onclick='makeSelection("${itemId}", "${title}", "${authorArr}")'>${title}</div><div id='${authorId}' class='author'>${authorArr}</div>
                    </div>
                    `;
                }).join('') +
            '</div>';
            // add list to UI
            document.getElementById('search-results').innerHTML = resultsList;
        } else {
            document.getElementById('add-selection').style.display = "unset";
        }
    }

    // indicate item is clicked
    function makeSelection(id, title, authors) {
        let clickedItem = document.getElementById(id);
        let addSelection = document.getElementById('add-selection')
        if (clicked === false) {
            addSelection.style.display = "unset";
            clickedItem.style.backgroundColor = "var(--main-bg-success-tertiary)";
            clickedItem.style.color = "var(--main-text-success)";
            selectionTitle = title; 
            selectionAuthors = authors;
            clicked = true;
        } else if (clicked === true) {
            addSelection.style.display = "none";
            clickedItem.style.backgroundColor = "var(--main-bg)";
            clickedItem.style.color = "var(--main-text)";
            clicked = false;
        }
        parent.postMessage({pluginMessage: {selectionTitle, selectionAuthors}}, '*');
    }

    // clear search results
    function clearAll() {
        const clear = true;
        document.getElementById('all-results').style.display = "none";
        document.getElementById('add-selection').style.display = "none";
        document.getElementById('plugin-message').style.display = "none";
        parent.postMessage({pluginMessage: {clear}}, '*');
    }

    // Submit selection to Figma and write text node
    document.getElementById('add-selection').onclick = () => {
        const submit = true;
        const clear = true;
        document.getElementById('all-results').style.display = "none";
        document.getElementById('add-selection').style.display = "none";
        document.getElementById('plugin-message').style.display = "unset";
        parent.postMessage({pluginMessage: {submit, selectionTitle, selectionAuthors}}, '*');
    }

    function openLogin() {
        let login = true;
        parent.postMessage({pluginMessage: {login}}, '*'); 
    }
    
  </script>